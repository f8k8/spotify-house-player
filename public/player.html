<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Web Playback SDK Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #191414;
      color: #ffffff;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #282828;
      border-radius: 8px;
    }
    h1 {
      color: #1DB954;
      text-align: center;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #333333;
    }
    .status.success {
      background-color: #1DB954;
      color: #000000;
    }
    .status.error {
      background-color: #E22134;
    }
    .info {
      margin: 10px 0;
    }
    .label {
      font-weight: bold;
      color: #1DB954;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽµ Spotify Web Playback SDK</h1>
    <div id="status" class="status">Initializing...</div>
    <div class="info">
      <div class="label">Player Name:</div>
      <div id="account-name">Loading...</div>
    </div>
    <div class="info">
      <div class="label">Device ID:</div>
      <div id="device-id">Not connected</div>
    </div>
    <div class="info">
      <div class="label">Player State:</div>
      <div id="player-state">Not initialized</div>
    </div>
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script>
    // Get player name from URL
    const urlParams = new URLSearchParams(window.location.search);
    const playerName = urlParams.get('playerName') || 'Unknown';
    const accountName = urlParams.get('accountName') || 'Unknown';
    document.getElementById('account-name').textContent = playerName;

    // Get access token from window context (set by puppeteer)
    const initialToken = window.SPOTIFY_ACCESS_TOKEN;

    if (!initialToken) {
      updateStatus('Error: No access token provided', 'error');
    } else {
      updateStatus('Access token loaded, initializing player...', 'success');
    }

    function updateStatus(message, type = '') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = 'status ' + type;
      console.log('[Status]', message);
    }

    function updateDeviceId(deviceId) {
      document.getElementById('device-id').textContent = deviceId || 'Not connected';
    }

    function updatePlayerState(state) {
      document.getElementById('player-state').textContent = state;
    }

    // Function to get OAuth token from backend
    async function getOAuthToken(cb) {
      try {
        const response = await fetch(`/api/accounts/${accountName}/token`);
        if (!response.ok) {
          throw new Error(`Failed to get token: ${response.status}`);
        }
        const data = await response.json();
        cb(data.token);
      } catch (error) {
        console.error('Error fetching OAuth token:', error);
        // Fallback to initial token if backend call fails
        cb(initialToken);
      }
    }

    // Spotify Web Playback SDK initialization
    window.onSpotifyWebPlaybackSDKReady = () => {
      updateStatus('Spotify SDK loaded, creating player...', 'success');

      const player = new Spotify.Player({
        name: playerName,
        getOAuthToken: getOAuthToken,
        volume: 0.5
      });

      // Error handling
      player.addListener('initialization_error', ({ message }) => {
        console.error('Initialization Error:', message);
        updateStatus(`Initialization Error: ${message}`, 'error');
      });

      player.addListener('authentication_error', ({ message }) => {
        console.error('Authentication Error:', message);
        updateStatus(`Authentication Error: ${message}`, 'error');
      });

      player.addListener('account_error', ({ message }) => {
        console.error('Account Error:', message);
        updateStatus(`Account Error: ${message}`, 'error');
      });

      player.addListener('playback_error', ({ message }) => {
        console.error('Playback Error:', message);
        updateStatus(`Playback Error: ${message}`, 'error');
      });

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        updateStatus('Player ready! Device registered with Spotify.', 'success');
        updateDeviceId(device_id);
        updatePlayerState('Ready');
      });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
        updateStatus('Device offline', 'error');
        updatePlayerState('Not Ready');
      });

      // Track whether we've notified about playback starting
      let hasNotifiedPlaybackStart = false;

      // Player state changed
      player.addListener('player_state_changed', (state) => {
        if (!state) {
          updatePlayerState('No active playback');
          // If we had an active playback before, notify that it has stopped
          if (hasNotifiedPlaybackStart) {
            notifyPlaybackStopped();
          }
          hasNotifiedPlaybackStart = false;
          return;
        }

        console.log('Player State Changed:', state);
        
        const track = state.track_window.current_track;
        const isPlaying = !state.paused;
        
        updatePlayerState(
          isPlaying 
            ? `Playing: ${track.name} by ${track.artists.map(a => a.name).join(', ')}` 
            : `Paused: ${track.name}`
        );

        // Notify backend when playback starts
        // Note: We intentionally don't await to keep the notification non-blocking
        if (isPlaying && !hasNotifiedPlaybackStart) {
          hasNotifiedPlaybackStart = true;
          notifyPlaybackStarted();
        }
      });

      // Function to notify backend that playback has started
      async function notifyPlaybackStarted() {
        try {
          console.log('Notifying backend that playback has started');
          const response = await fetch(`/api/players/${accountName}/playback-started`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            console.log('Backend notified successfully');
          } else {
            console.warn('Failed to notify backend:', response.status);
          }
        } catch (error) {
          console.error('Error notifying backend:', error);
        }
      }

      // Function to notify backend that playback has stopped
      async function notifyPlaybackStopped() {
        try {
          console.log('Notifying backend that playback has stopped');
          const response = await fetch(`/api/players/${accountName}/playback-stopped`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            console.log('Backend notified of playback stop successfully');
          } else {
            console.warn('Failed to notify backend of playback stop:', response.status);
          }
        } catch (error) {
          console.error('Error notifying backend of playback stop:', error);
        }
      }

      // Connect to the player
      player.connect().then(success => {
        if (success) {
          console.log('Successfully connected to Spotify!');
          updateStatus('Connected to Spotify!', 'success');
        } else {
          console.error('Failed to connect to Spotify');
          updateStatus('Failed to connect to Spotify', 'error');
        }
      });

      // Keep reference to player
      window.spotifyPlayer = player;
    };

    // Log that we're waiting for SDK
    console.log('Waiting for Spotify Web Playback SDK to load...');
  </script>
</body>
</html>
